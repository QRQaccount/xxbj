### 模拟量与数字量
- 音频，图像，压力，位移等都是模拟量，而单片机内部运算时所采用的的全部为数字量。通常我们要在外界信号输入的时候
加上A/D芯片来将模拟量转换为数字量，在输出时加上D/A芯片将数字量转换为模拟量

---
## A/D转换
---
### A/D转换原理及参数指标

1. 采样定理
    * 输入的模拟信号是连续的，而数字信号是离散的。在进行A/D转换的时候，在选定的时间对输入的模拟信号进行采样。
一般A/D转换由三个步骤来完成，采样保持，量化，编码
> 为了不失真地恢复模拟信号，采样频率应该不小于模拟信号频谱中最高频率的2倍。 　
>>f s≥2f max

2. 量化和编码
    - 在采样数字量表示电压的时候，必须将它转换为最小数字单位的整数倍，这个过程称为量化。规定的最小整数单位称为量化单位
    - 将取到的电压以二进制的形式保存称为编码
    - 因为模拟信号的的电压无法整除最小整数单位，这是就会引入量化误差。在把模拟信号划分成不同的量化等级的时候，不
    同的划分方法会得到不同的误差
>   例如划分1v的电压，我们通常采用最小单位为2/15v的划分方式。编码000对应的是1/15v。这样的划分方式，最大的量化误差值为1/15v。八位AD转换器最小量化单位计算公式：N\*(8*2-1)

3. 采样保持电路
    采样保持电路(采样/保持器)又称为采样保持放大器。当对模拟信号进行A/D转换时，需要一定的转换时间，在这个转换时间内，模拟信号要保持基本不变，这样才能保证转换精度。采样保持电路即为实现这种功能的电路
    在单片机开发板上使用LF198电路
    ![](/单片机入门\img\LF198.png)

4. A/D直接转换电路
    1. 并行比较型ADC
        ![](/单片机入门\img\并行比较ADC.png)
        这个是三位并行比较型ADC转换电路，由电压比较器，寄存器和代码比较器组成。
        1. 比较的步骤
            1. 使用电阻链将参考电压分压，得到1/15~13/15V七个比较电压
            2. 再将电压与输入电压进行一次比较，将比较结果存入寄存器
        2. 并行比较器的特点
            - 由于转换是并行的，转换的延时只受比较器，触发器，编码器的延时限制，转换速度快
            - 随着分辨率提高，原件个数成集合数增长，电路越来越复杂，制作高分辨率的并行转换器十分困难
            - 使用这个不用外加保持-采样电路
    2. 反馈比较型ADC
        取一个数字量加到D/A转化器上，将输出模拟电压与输入的模拟电压信号之间进行比较，若不相等则调整输入的数字量。当两模拟电压相等时，数字量即为结果
        1. 计数比较型
            ![](/单片机入门\img\计数型ADC.png)
            1. 工作原理
                由比较器，D/A转换器，计数器，脉冲源，控制门以及输出寄存器组成
                1. 复位信号将计数器全部置零，转换信号V<sub>L</sub>停留在0v，门G封锁
                2. 当输入正电压信号，转换器输出正电压，门打开。计数器开始工作
                3. 因为数字状态在一直变化不宜将计数器的存值直接输出，所以需要设置输出寄存器
            2. 特点
                - 电路简单
                - 转换速度慢，适用于对转换速度没有要求的电路
        2. 逐次比较型
            ![](/单片机入门\img\逐次比较型ADC.png)
            转换时间与其位数和时钟脉冲频率有关
            >逐次逼近转换过程和用天平称物重非常相似。天平称重物过程是，从最重的砝码开始试放，与被称物体行进比较，若物体重于砝码，则该砝码保留，否则移去。再加上第二个次重砝码，由物体的重量是否大于砝码的重量决定第二个砝码是留下还是移去。照此一直加到最小一个砝码为止。将所有留下的砝码重量相加，就得此物体的重量。仿照这一思路，逐次比较型A/D转换器，就是将输入模拟信号与不同的参考电压作多次比较，使转换所得的数字量在数值上逐次逼近输入模拟量对应值。

            2. 特点
                - 速度快
                - 精度高
    3. 间接A/D转换器
        V-T变换型
        V-F变换型
5. 参数指标
    - 分辨率(1/2<sup>n</sup>)
    - 转换误差
    - 转换精度
    - 转换时间

### 单片机中ADC0804的使用
![ADC0804](/单片机入门\img\ADC0804.png)
+ ADC0804针脚图

![](/单片机入门\img\ADC0804外部电路图.jpg)
+ 外部电路图
    - Vin（+）接电位器的中间滑动端，Vin（-）接地，因为这两端可以输入差分电压，即它可测量Vin（+）与Vin（-）之间的电压。
    - CLKR,CLR,GND之间用电阻和电容组成RC震荡电路，用来给ADC0804提供所需的脉冲。


1. 主要参数：
    ADC0804是一款8位、单通道、低价格A/D转换器。 (1) 高阻抗状态输出 (2) 分辨率
    ：8 位(0~255) (3) 存取时间：135 ms (4) 转换时间：100 ms (5) 总误差：-
    1~+1LSB (6) 工作温度：ADC0804C为0度~70度；ADC0804L为-40 度~85 度 (7) 模
    拟输入电压范围：0V~5V
2. 各针脚作用:

|针脚|作用|
|:-:|:-:|
|Vin（+）、Vin（-）|两个模拟信号输入端，可以接收单极性、双极性和差模输入信号。|
|DB0-DB7|具有三态特性数字信号输出端，输出结果为八位二进制结果|
|CLKIN|时钟信号输入端。|
|CLKR|内部时钟发生器的外接电阻端，与CLK端配合可由芯片自身产生时钟脉冲，其频率计算方式是：fck=1/(1.1RC）。|
|CS|片选信号输入端，低电平有效|
|WR|写信号输入端，低电平启动AD转换|
|RD|读信号输入端，低电平输出端有效。|
|INTR|转换完毕中断提供端，AD转换结束后，低电平表示本次转换已完成|
|VREF/2|参考电平输入，决定量化单位|
|VCC|芯片电源5V输入|
|AGND|模拟电源地线|
|DGND|数字信号地线|

3. io口的操作和程序编写
    1. 程序初始的时候将CS开启(置0)便不用再去操作
    2. wr先置高，延时；再置低，延时；再置高（使用_nop_函数）才能启动A/D转换器
    3. 再延时（1~8给内部周期+T<sub>c</sub>）
    4. 读取前将P1口全部置1
    5. rd先置高，延时；再置低，延时；使A/D读使能


- 代码节选
    ```c
    while(1)           //进入死循环不停地做模数转换
    {
        adwr=1;
        _nop_();
        adwr=0;
        _nop_();
        adwr=1;
         // 启动AD转换（根据时序图来的）
        for(a=10;a>0;a--)
        {
            display(A1,A2,A3);     
            //兼具显示和延时的作用，因为转换需要经过一定的时间，
            //用这个for循环可以起到延时的作用
        }

        P1=0xff;                    //读取P1口之前先给其写全1

        adrd=1;                    //rd置1（根据时序图可知）
        _nop_();                    //延时一个机器周期（根据时序图可知）
        adrd=0;                     //rd置0（根据时序图可知）
        _nop_();                    //延时一个机器周期
        adval=P1;            //A/D转换后的数据赋给adval
        adrd=1;             //转换后的数字信号（二进制的信号应该已经译成了十进制了）读出（也是根据时序图可知）

        A1=adval/100;      /*-----------------------------------------*/
        A2=adval%100/10;    /*分离转换后的十进制数，用来给数码管显示*/
        A3=adval%10;       /*-----------------------------------------*/

     }
    ```

---
## D/A转换
---
### D/A转换的原理
1. 基本原理
    数字量是用代码按数位组合起来表示的，对于有权码，每位代码都有一定的权。为了将数字量转换成模拟量，必须将每一位的代码按其权的大小转换成相应的模拟量，然后将这些模拟量相加，即可得与数字量成
    正比的模拟量，从而实现了数字—模拟转换
    ![](/单片机入门\img\DA基本原理.jpg)
    d<sub>0</sub>~d<sub>n-1</sub>代表输入的n位二进制数，V<sub>0</sub>成比例的输出电压

2. 权电阻网络D/A转换器
    ![](/单片机入门\img\权电阻DAC.png)

    - V<sub>0</sub>的输出最大变化范围在0~(2<sup>n</sup>-1)/2<sup>n</sup>V<sub>REF</sub>
    >推导:
    在运算放大器的输出电流为零且输入电阻为零的时候
    v<sub>0</sub> = -R<sub>f</sub> i<sub>&sum;</sub> = -R<sub>f</sub>(I<sub>3</sub>+I<sub>2</sub>+I<sub>1</sub>+I<sub>0</sub>)
    各支路电流分别为
    I<sub>x</sub> = V<sub>REF</sub> \* d<sub>x</sub>/(2<sup>3-x</sup> \* R)
    即![](/单片机入门\img\公式01.jpg)

    - 特点：
        简单
        电阻值相差大，难于保证精度
3. 倒T型电阻网络DAC
    ![](/单片机入门\img\倒T型.png)
    1. 工作原理
        当输入信号为0时S<sub>i</sub>接地，当输入信号为1时S<sub>i</sub>接运放
        反向输入端(虚地)。这样无论开关在哪个位置，流过各支路的大小电流为常数倍
        的I。
        所以流经运放的总电流i<sub>&sum;</sub>为
        ![](/单片机入门\img\倒T形公式.png)
    2. 对电路的要求
        - 基准电压稳定性好
        - 电阻R比上2R大小精确
        - 每个模拟开关的电压降要相等
    3. 特点
        - 转换速度快
        - 减伤动态输出时的尖脉冲
4. 权电流型DAC
    ![](/单片机入门\img\权电流型DAC.png)

    ![](/单片机入门\img\权电流电路公式.png)
    尽管倒T型电阻网络D/A转换器具有较高的转换速度，但由于电路中存在模拟开关电压
    降，当流过各支路的电流稍有变化时，就会产生转换误差。为进一步提高D/A转换器的
    精度，可采用权电流型D/A转换器。
    其中用恒定的电流源代替了电阻网络
5. 参数指标
    1. 分辨率
    2. 转换误差
    3. 建立时间
    4. 转换速率
    5. 温度系数

### 单片机中DAC0832的使用
![](/单片机入门\img\DAC0832内部&针脚图.png)

- 集成电路内有两级输入寄存器


1. 主要参数
    * DAC0832是8位的D/A转换集成芯片。电流稳定时间1us；
    * 可单缓冲、双缓冲或直接数字输入；
    * 只需在满量程下调整其线性度；
    * 单一电源供电（+5V～+15V）；
    * 低功耗，20mW。
2. 针脚及其作用

|针脚|作用|
|:-:|:-:|
|D0~Dx7|数据输入线，TLL电平。|
|ILE|数据锁存允许控制信号输入线，高电平有效。|
|CS|片选信号输入线，低电平有效。|
|WR1|输入器的写选通输入端，负脉冲有效。CS为0，WR<sub>1</sub>与ILE为1,DI0<br/>到DI7状态被输入到输入寄存器|
|XFER|数据传送控制信号输入线，低电平有效。|
|WR2|DAC寄存器写选通输入线。XEFR为0且WR<sub>2</sub>有效时输入寄存器的状态被输<br/>入DAC寄存器中|
|Iout1|电流输出线。当输入全为1时Iout1最大。|
|Iout2|电流输出线。其值与Iout1之和为一常数。|
|Rfb|反馈信号输入线,芯片内部有反馈电阻。|
|Vcc|电源输入线 (+5v~+15v)|
|Vref|基准电压输入线 (-10v~+10v)|
|AGND|模拟地,摸拟信号和基准电源的参考地。|
|DGND|数字地,两种地线在基准电源处共地比较好。|

3. 三种工作方式
    1. 直通方式
        信息不经过两级所存寄存机锁存，WR<sub>1</sub>,WR<sub>2</sub>，XEFR，CS接口均接地，ILE接+5V数字量一旦输入直接进入D/A寄存器
    2. 双缓冲方式。
        双缓冲方式是先使输入寄存器接收资料，再控制输入寄存器的输出资料到DAC寄存器，即分两次锁存输入资料。此方式适用于多个D/A转换同步输出的情节。
    3. 单缓冲方式
        单缓冲方式是控制输入寄存器和DAC寄存器同时接收资料，或者只用输入寄存器而把DAC寄存器接成直通方式。此方式适用只有一路模拟量输出或几路模拟量异步输出的情形。
4. 程序节选
![](/单片机入门\img\DAC0832时序图.jpg)
    ```c
        // 若只完成一次转换，转换完成后将wr和cs拉高即可
        // 若要进行持续转换则一直置低
        dawr = 0;
        dacs = 0;
    ```
